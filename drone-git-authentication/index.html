<!DOCTYPE html>
<html lang="en">

  <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
		<title>
				Drone の build 実行時の認証方法 &middot; melody
		</title>
	
		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
	
		
		<link rel="icon" type="image/png" sizes="32x32" href="https://suzuki-shunsuke.github.io/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="https://suzuki-shunsuke.github.io/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="https://suzuki-shunsuke.github.io/images/apple-touch-icon.png">
	
		
		<link href="" rel="alternate" type="application/rss+xml" title="melody" />
	</head>
	

  <body>
		<nav class="nav">
			<div class="nav-container">
			<a href="https://suzuki-shunsuke.github.io/">
				<h2 class="nav-title">melody</h2>
			</a>
			<ul>
				<li><a href="https://suzuki-shunsuke.github.io/about">About</a></li>
				<li><a href="https://suzuki-shunsuke.github.io/">Posts</a></li>
			</ul>
			</div>
		</nav>


<main>
	<div class="post">
		<div class="post-info">
		<span>Written by</span>
			
			<br>
			<span>on&nbsp;</span><time datetime="2018-09-30 19:44:27 &#43;0900 &#43;0900">September 30, 2018</time>
		</div>

		<h1 class="post-title">Drone の build 実行時の認証方法</h1>
		<div class="post-line"></div>

		

<p>drone の build における GitHub (GitHub前提で書きますが、GitHub以外でも同じだと思います) の認証の話(どうやって認証しているか)について書いておこうと思います。
drone の build は clone step で対象のリポジトリを GitHub から clone してきています。
この際に何かしらの方法で認証しているはずです。</p>

<p>結論を言うと、</p>

<p>あるリポジトリAのbuildでは、
リポジトリAの <strong>drone連携を有効化したユーザー</strong> Bの access token を <strong>.netrc</strong> に書き込んで認証しています。
よってユーザーBにcloneする権限があるリポジトリはcloneできるし、
ユーザーBにcloneする権限がないリポジトリはcloneできません。
つまり、 <strong>誰が連携を有効化するかが重要</strong> になります(これについては後述します)。
なお、drone連携の有効化はそのリポジトリのowner以上でないと出来ません。</p>

<p>drone上でリポジトリの連携を有効化すると、
リポジトリのHookが作成されます。
リポジトリの settings &gt; Hooks から確認できます。
この Hook の Payload URL を見ると access_token クエリがあると思います。
JWTのようですね。これはリポジトリの連携を有効化したユーザーのtokenです。</p>

<p>このtokenが GitHub から drone への webhook のパラメータとして送られてくるので、
drone 側で認証し、認証したユーザーのGitHub  のaccess token を取得し、
build 時にコンテナの /root/.netrc に書き込むようです。</p>

<p>.netrcに書き込まれているのは試しに個人の private repository で .netrc をcatしてみればわかります。
他人も見えるrepositoryでcatすると悪用されかねないので気をつけましょう。</p>

<pre><code>pipeline:
netrc:
image: alpine:3.6
commands:
- cat ~/.netrc
</code></pre>

<pre><code>+ cat ~/.netrc
machine gihub.com
login **************
password x-oauth-basic
</code></pre>

<h2 id="cloneステップ以外での-netrcの活用">cloneステップ以外での .netrcの活用</h2>

<p>.netrc のおかげで難しいこと考えずに clone 出来ているわけですが、この .netrc は当然 clone ステップ以外でも使えます。
例えば private repository の ansible role の install です。</p>

<p>roles.yml</p>

<pre><code class="language-yaml">- src: https://github.com/&lt;owner&gt;/&lt;repo&gt;
  name: foo.bar
  scm: git
</code></pre>

<p>.drone.yml</p>

<pre><code class="language-yaml">commands:
- ansible-galaxy install -r roles.yml
</code></pre>

<h2 id="誰が連携を有効化するべきか">誰が連携を有効化するべきか</h2>

<p>結論を言うと、ベストな方法は分かりません。</p>

<p>連携を有効化した人が退職してしまったり、organizationから抜けてしまった場合、急にビルドが失敗するリスクがあります。
理想を言えば特定の個人のアカウントで連携するのではなく、連携用のアカウントを用意するのが良いのかもしれませんが、
それはそれで運用が難しいかもしれません。</p>

<p>drone API ないし CLI で有効化は出来るので、CIで連携を自動化することは可能だと思います。</p>

<ul>
<li><a href="http://docs.drone.io/cli-repository-add/">http://docs.drone.io/cli-repository-add/</a></li>
<li><a href="http://docs.drone.io/api-repo-create/">http://docs.drone.io/api-repo-create/</a></li>
</ul>

<p>自分のところではまだそこまでやってなく、個人で有効化してしまっているのですが、
自動化したらまた記事にでもしたいと思います。</p>


	</div>

	<div class="pagination">
		<a href="/drone-circle-volume-difference/" class="left arrow">&#8592;</a>
		<a href="/drone-build-timeout/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>		<footer>
			<span>
			&copy; <time datetime="2019-04-02 02:38:57.941706839 &#43;0000 UTC m=&#43;0.069293435">2019</time> . Made with Hugo using the <a href="https://github.com/EmielH/tale-hugo/">Tale</a> theme.
			</span>
		</footer>
  </body>
</html>