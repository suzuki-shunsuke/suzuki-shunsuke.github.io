<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.59.1" />



<link rel="canonical" href="https://suzuki-shunsuke.github.io/terraform-state-locking/">


    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css">
    <title>Terraform の State Locking の概要 - melody</title>
    
<meta name="description" content="Terraform の State Locking という機能の概要について説明します。 ただし、自分もちゃんと理解しているわけではないので、推測も混じります。 基本的には公式ドキュメントに書いてある内容なのでそちらをご参照ください。State Locking とは terraform plan などのコマンドは State を変更する場合があります。 その処理は atomic ではないため、同時に複数のコマンドが State を書き換えようとすると不整合が生じる可能性があります。例えば S3 backend の state を state rm で更新する場合を考えます。 これはコマンド内部で 現在の State を取得する (READ) 修正した State を S3 に push する (WRITE)  という処理を行っているはずであり、複数のコマンドを実行した場合、READ と WRITE の間に他のコマンドによって WRITE されると、その WRITE による変更が消えてしまいます。そこで State Locking を使うと各コマンドで State を変更する前に lock を取り、WRITE 後に lock を解除します。コマンドラインオプション plan, apply, refresh, state rm, state mv, state push には次のようなオプションがあります。">

<meta property="og:title" content="Terraform の State Locking の概要 - melody">
<meta property="og:type" content="article">
<meta property="og:url" content="https://suzuki-shunsuke.github.io/terraform-state-locking/">
<meta property="og:image" content="https://suzuki-shunsuke.github.io/images/default.png">
<meta property="og:site_name" content="melody">
<meta property="og:description" content="Terraform の State Locking という機能の概要について説明します。 ただし、自分もちゃんと理解しているわけではないので、推測も混じります。 基本的には公式ドキュメントに書いてある内容なのでそちらをご参照ください。State Locking とは terraform plan などのコマンドは State を変更する場合があります。 その処理は atomic ではないため、同時に複数のコマンドが State を書き換えようとすると不整合が生じる可能性があります。例えば S3 backend の state を state rm で更新する場合を考えます。 これはコマンド内部で 現在の State を取得する (READ) 修正した State を S3 に push する (WRITE)  という処理を行っているはずであり、複数のコマンドを実行した場合、READ と WRITE の間に他のコマンドによって WRITE されると、その WRITE による変更が消えてしまいます。そこで State Locking を使うと各コマンドで State を変更する前に lock を取り、WRITE 後に lock を解除します。コマンドラインオプション plan, apply, refresh, state rm, state mv, state push には次のようなオプションがあります。">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="melody">
<meta name="twitter:url" content="https://suzuki-shunsuke.github.io/terraform-state-locking/">
<meta name="twitter:title" content="Terraform の State Locking の概要 - melody">
<meta name="twitter:description" content="Terraform の State Locking という機能の概要について説明します。 ただし、自分もちゃんと理解しているわけではないので、推測も混じります。 基本的には公式ドキュメントに書いてある内容なのでそちらをご参照ください。State Locking とは terraform plan などのコマンドは State を変更する場合があります。 その処理は atomic ではないため、同時に複数のコマンドが State を書き換えようとすると不整合が生じる可能性があります。例えば S3 backend の state を state rm で更新する場合を考えます。 これはコマンド内部で 現在の State を取得する (READ) 修正した State を S3 に push する (WRITE)  という処理を行っているはずであり、複数のコマンドを実行した場合、READ と WRITE の間に他のコマンドによって WRITE されると、その WRITE による変更が消えてしまいます。そこで State Locking を使うと各コマンドで State を変更する前に lock を取り、WRITE 後に lock を解除します。コマンドラインオプション plan, apply, refresh, state rm, state mv, state push には次のようなオプションがあります。">
<meta name="twitter:image" content="https://suzuki-shunsuke.github.io/images/default.png">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"https:\/\/suzuki-shunsuke.github.io\/"
    },
    "headline": "Terraform の State Locking の概要 - melody",
    "image": {
      "@type": "ImageObject",
      "url": "https:\/\/suzuki-shunsuke.github.io\/images\/default.png",
      "height": 800,
      "width": 800
    },
    "datePublished": "2020-01-10T16:18:05JST",
    "dateModified": "2020-01-10T16:18:05JST",
    "author": {
      "@type": "Person",
      "name": "melody"
    },
    "publisher": {
      "@type": "Organization",
      "name": "melody",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/suzuki-shunsuke.github.io\/images/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "Terraform の State Locking という機能の概要について説明します。 ただし、自分もちゃんと理解しているわけではないので、推測も混じります。 基本的には公式ドキュメントに書いてある内容なのでそちらをご参照ください。\nState Locking とは terraform plan などのコマンドは State を変更する場合があります。 その処理は atomic ではないため、同時に複数のコマンドが State を書き換えようとすると不整合が生じる可能性があります。\n例えば S3 backend の state を state rm で更新する場合を考えます。 これはコマンド内部で\n 現在の State を取得する (READ) 修正した State を S3 に push する (WRITE)  という処理を行っているはずであり、複数のコマンドを実行した場合、READ と WRITE の間に他のコマンドによって WRITE されると、その WRITE による変更が消えてしまいます。\nそこで State Locking を使うと各コマンドで State を変更する前に lock を取り、WRITE 後に lock を解除します。\nコマンドラインオプション plan, apply, refresh, state rm, state mv, state push には次のようなオプションがあります。"
  }
</script>


    <link href="https://suzuki-shunsuke.github.io/css/styles.css" rel="stylesheet">
    

  </head>

  <body>
    
    
    

    <header class="l-header">
      <nav class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://suzuki-shunsuke.github.io/">melody</a>
          </div>

          

        </div>
      </nav>
    </header>

    <main>
      <div class="container">
        
<div class="row">
  <div class="col-md-8">

    <nav class="p-crumb">
      <ol class="breadcrumb">
        <li><a href="https://suzuki-shunsuke.github.io/"><i class="fa fa-home" aria-hidden="true"></i></a></li>
        
        <li class="active">Terraform の State Locking の概要</li>
      </ol>
    </nav>

    <article class="single">
  <header>
    <ul class="p-facts">
      <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2020-01-10T16:18:05JST">Jan 10, 2020</time></li>
      
      
    </ul>

    <h1 class="title">Terraform の State Locking の概要</h1>
    
    
    <section>
      <div>
        <ul class="p-terms">
          
          <li><a href="https://suzuki-shunsuke.github.io/tags/terraform/">terraform</a></li>
          
        </ul>
      </div>
    </section>
    
  </header>

  

  <div class="article-body">

<p>Terraform の <a href="https://www.terraform.io/docs/state/locking.html">State Locking</a> という機能の概要について説明します。
ただし、自分もちゃんと理解しているわけではないので、推測も混じります。
基本的には公式ドキュメントに書いてある内容なのでそちらをご参照ください。</p>

<h2 id="state-locking-とは">State Locking とは</h2>

<p><code>terraform plan</code> などのコマンドは State を変更する場合があります。
その処理は atomic ではないため、同時に複数のコマンドが State を書き換えようとすると不整合が生じる可能性があります。</p>

<hr />

<p>例えば S3 backend の state を state rm で更新する場合を考えます。
これはコマンド内部で</p>

<ol>
<li>現在の State を取得する (READ)</li>
<li>修正した State を S3 に push する (WRITE)</li>
</ol>

<p>という処理を行っているはずであり、複数のコマンドを実行した場合、READ と WRITE の間に他のコマンドによって WRITE されると、その WRITE による変更が消えてしまいます。</p>

<hr />

<p>そこで State Locking を使うと各コマンドで State を変更する前に lock を取り、WRITE 後に lock を解除します。</p>

<h2 id="コマンドラインオプション">コマンドラインオプション</h2>

<p>plan, apply, refresh, state rm, state mv, state push には次のようなオプションがあります。</p>

<pre><code>-lock=true          Lock the state file when locking is supported.
-lock-timeout=0s    Duration to retry a state lock.
</code></pre>

<p><code>-lock</code> はデフォルトで true なので State Locking のことを知らなくても実は State Locking 使ってたということもありえますが、 Backend type によっては State Locking のための設定をしていないと State Locking が無効になっている可能性があります。</p>

<p>例えば S3 backend で State Locking をするには DynamoDB が必要であり、 DynamoDB の設定 <code>dynamodb_table</code> が設定されていないと State Locking は無効になります。</p>

<p>また、<code>-lock=false</code> で無効化できますが、公式的に非推奨になります。</p>

<p><code>-lock-timeout</code> は lock の取得に失敗した場合に何秒後にリトライするかの設定になります。</p>

<h2 id="force-unlock">force-unlock</h2>

<p>lock の解放に失敗した場合のために、 <a href="https://www.terraform.io/docs/commands/force-unlock.html">force-unlock</a> というコマンドがあります。
何らかのトラブルで lock が解放されない場合に使います。</p>

<pre><code>$ terraform force-unlock LOCK_ID
</code></pre>

<p>例えば plan を実行中にキャンセルすると lock が解放されないことがあるようです。</p>

<p>lock が解放されていない状態で plan などを実行すると lock の取得に失敗し、次のようなエラーが起こります。</p>

<pre><code>Acquiring state lock. This may take a few moments...
Error: Error locking state: Error acquiring the state lock: ConditionalCheckFailedException: The conditional request failed
	status code: 400, request id: xxx
Lock Info:
  ID:        xxx
  Path:      terraform.tfstate
  Operation: OperationTypePlan
  Who:       xxx
  Version:   0.12.13
  Created:   2020-01-09 09:30:37.41120929 +0000 UTC
  Info:      
Terraform acquires a state lock to protect the state from being written
by multiple users at the same time. Please resolve the issue above and try
again. For most commands, you can disable locking with the &quot;-lock=false&quot;
flag, but this is not recommended.
</code></pre>

<p>ここで出力される ID を force-unlock の引数として指定します。</p>

<pre><code>$ terraform force-unlock xxx
Do you really want to force-unlock?
  Terraform will remove the lock on the remote state.
  This will allow local Terraform commands to modify this state, even though it
  may be still be in use. Only 'yes' will be accepted to confirm.
  Enter a value: yes
Terraform state has been successfully unlocked!
The state has been unlocked, and Terraform commands should now be able to
obtain a new lock on the remote state.
</code></pre>

<h2 id="s3-backend">S3 backend</h2>

<p>State Locking をサポートしているかは Backend type によりますが、 S3 の場合、 DynamoDB を使えばできます。</p>

<p><a href="https://www.terraform.io/docs/backends/types/s3.html#configuration-variables">https://www.terraform.io/docs/backends/types/s3.html#configuration-variables</a></p>

<p>backend の設定で <code>dynamodb_table</code> を設定する必要があります。</p>

<p><a href="https://www.terraform.io/docs/backends/types/s3.html#dynamodb_table">https://www.terraform.io/docs/backends/types/s3.html#dynamodb_table</a></p>

<blockquote>
<p>dynamodb_table - (Optional) The name of a DynamoDB table to use for state locking and consistency. The table must have a primary key named LockID. If not present, locking will be disabled.</p>
</blockquote>

<pre><code class="language-hcl">data &quot;terraform_remote_state&quot; &quot;network&quot; {
  backend = &quot;s3&quot;
  config = {
    bucket = &quot;terraform-state-prod&quot;
    key    = &quot;network/terraform.tfstate&quot;
    region = &quot;us-east-1&quot;

    # state locking の設定
    dynamodb_table = &quot;???&quot;
  }
}
</code></pre>

<p>IAMの権限としては <a href="https://www.terraform.io/docs/backends/types/s3.html#dynamodb-table-permissions">https://www.terraform.io/docs/backends/types/s3.html#dynamodb-table-permissions</a> が必要です。</p>

<p>DynamoDB のテーブルには <code>LockID</code> という Primary Key が必要です。 型は <code>文字列</code> です。</p>

<p>そして State Locking を有効にした状態で plan などを実行すると
DynamoDB のテーブルにレコードが State ごとに作られるようです。</p>

<h2 id="state-locking-をすれば安全-というわけではない">State Locking をすれば安全、というわけではない</h2>

<p>State Locking 自体は安全性に寄与する仕組みではありますが、 State Locking さえすれば安全かというとそうではないと思います。</p>

<p>複数人が同時に plan や apply などを実行する環境では、別のロック機構も必要だと思います。</p>

<p>詳細はまた別途書こうと思いますが、CI/CD で plan, apply などを実行する場合、 apply 実行中はそれが終わるまで他の plan や apply の実行を wait するような仕組みがないと危険です。</p>
</div>

  <footer class="article-footer">
    
    
    <section class="bordered">
      <header>
        <div class="panel-title">TAGS</div>
      </header>
      <div>
        <ul class="p-terms">
          
          <li><a href="https://suzuki-shunsuke.github.io/tags/terraform/">terraform</a></li>
          
        </ul>
      </div>
    </section>
    
  </footer>

</article>


    
  </div>

  <div class="col-md-4">
    
<aside class="l-sidebar">

  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">LATESTS</div>
    </div>
    <div class="list-group">
      
      <a href="https://suzuki-shunsuke.github.io/buildflow-input-output/" class="list-group-item">buildflow の task の input, output という機能</a>
      
      <a href="https://suzuki-shunsuke.github.io/buildflow-split-files/" class="list-group-item">buildflow で設定ファイルを分割する</a>
      
      <a href="https://suzuki-shunsuke.github.io/buildflow-parameter/" class="list-group-item">buildflow の script や template に渡される parameter</a>
      
      <a href="https://suzuki-shunsuke.github.io/buildflow-task/" class="list-group-item">buildflow の task の設定項目</a>
      
      <a href="https://suzuki-shunsuke.github.io/buildflow-build-phase-task/" class="list-group-item">buildflow の build, phase, task について</a>
      
      <a href="https://suzuki-shunsuke.github.io/buildflow-tengo/" class="list-group-item">buildflow での Tengo の使い方</a>
      
      <a href="https://suzuki-shunsuke.github.io/buildflow-1/" class="list-group-item">buildflow というワークフローエンジンのようなタスクランナーのようなツールを作っている</a>
      
      <a href="https://suzuki-shunsuke.github.io/post-tfnotify-parse-error/" class="list-group-item">tfnotify の parse error を通知する</a>
      
      <a href="https://suzuki-shunsuke.github.io/codebuild-1/" class="list-group-item">AWS CodeBuild 良さそう</a>
      
      <a href="https://suzuki-shunsuke.github.io/github-comment/" class="list-group-item">github-comment - GitHub にコメントを投稿する CLI</a>
      
    </div>
  </section>

  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">TAG</div>
    </div>
    <div class="list-group">
      
      <a href="https://suzuki-shunsuke.github.io/tags/oss" class="list-group-item">oss (22)</a>
      
      <a href="https://suzuki-shunsuke.github.io/tags/drone" class="list-group-item">drone (14)</a>
      
      <a href="https://suzuki-shunsuke.github.io/tags/buildflow" class="list-group-item">buildflow (7)</a>
      
      <a href="https://suzuki-shunsuke.github.io/tags/terraform" class="list-group-item">terraform (7)</a>
      
      <a href="https://suzuki-shunsuke.github.io/tags/golang" class="list-group-item">golang (6)</a>
      
      <a href="https://suzuki-shunsuke.github.io/tags/graylog" class="list-group-item">graylog (5)</a>
      
      <a href="https://suzuki-shunsuke.github.io/tags/circleci" class="list-group-item">circleci (4)</a>
      
      <a href="https://suzuki-shunsuke.github.io/tags/ansible" class="list-group-item">ansible (3)</a>
      
      <a href="https://suzuki-shunsuke.github.io/tags/ci" class="list-group-item">ci (2)</a>
      
      <a href="https://suzuki-shunsuke.github.io/tags/datadog" class="list-group-item">datadog (2)</a>
      
    </div>
  </section>

  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">ARCHIVE</div>
    </div>
    <div class="list-group">
      
      <a href="https://suzuki-shunsuke.github.io/archives/2020/10" class="list-group-item">2020/10 (7)</a>
      
      <a href="https://suzuki-shunsuke.github.io/archives/2020/09" class="list-group-item">2020/09 (1)</a>
      
      <a href="https://suzuki-shunsuke.github.io/archives/2020/08" class="list-group-item">2020/08 (1)</a>
      
      <a href="https://suzuki-shunsuke.github.io/archives/2020/07" class="list-group-item">2020/07 (2)</a>
      
      <a href="https://suzuki-shunsuke.github.io/archives/2020/05" class="list-group-item">2020/05 (1)</a>
      
      <a href="https://suzuki-shunsuke.github.io/archives/2020/04" class="list-group-item">2020/04 (2)</a>
      
      <a href="https://suzuki-shunsuke.github.io/archives/2020/01" class="list-group-item">2020/01 (3)</a>
      
      <a href="https://suzuki-shunsuke.github.io/archives/2019/11" class="list-group-item">2019/11 (3)</a>
      
      <a href="https://suzuki-shunsuke.github.io/archives/2019/08" class="list-group-item">2019/08 (5)</a>
      
      <a href="https://suzuki-shunsuke.github.io/archives/2019/07" class="list-group-item">2019/07 (2)</a>
      
    </div>
  </section>

</aside>


  </div>
</div>

      </div>
    </main>

    <footer class="l-footer">
      <div class="container">
        <p><span class="h-logo">&copy; melody</span></p>
        <aside>
          <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
          <p><a href="https://github.com/dim0627/hugo_theme_beg">Beg</a> designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>.</p>
        </aside>
      </div>
    </footer>

    <script src="//code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

